<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Controle do Carro</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      margin: 0;
      padding: 20px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    .header {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    h1 {
      color: #333;
      margin: 0;
    }
    
    .car-info {
      color: #666;
      font-size: 14px;
    }
    
    .back-btn {
      background: #3498db;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      text-decoration: none;
      display: inline-block;
    }
    
    .back-btn:hover {
      background: #2980b9;
    }
    
    .main-content {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 20px;
      flex: 1;
    }
    
    .video-container {
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      text-align: center;
    }
    
    .video-title {
      color: #333;
      margin-bottom: 15px;
      font-size: 18px;
    }
    
    .video-stream {
      width: 100%;
      max-width: 640px;
      height: 480px;
      background: #000;
      border-radius: 10px;
      object-fit: cover;
    }
    
    .video-placeholder {
      width: 100%;
      max-width: 640px;
      height: 480px;
      background: #f8f9fa;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #666;
      font-size: 16px;
      margin: 0 auto;
    }
    
    .controls-container {
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }
    
    .controls-title {
      color: #333;
      margin-bottom: 20px;
      font-size: 18px;
      text-align: center;
    }
    
    .control-grid {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      grid-template-rows: 1fr 1fr;
      gap: 10px;
      max-width: 200px;
      margin: 0 auto;
    }
    
    .control-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 10px;
      padding: 20px;
      cursor: pointer;
      font-size: 24px;
      font-weight: bold;
      transition: all 0.2s;
      user-select: none;
    }
    
    .control-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }
    
    .control-btn:active {
      transform: scale(0.95);
    }
    
    .control-btn:disabled {
      background: #bdc3c7;
      cursor: not-allowed;
      transform: none;
    }
    
    .forward {
      grid-column: 2;
      grid-row: 1;
    }
    
    .left {
      grid-column: 1;
      grid-row: 2;
    }
    
    .backward {
      grid-column: 2;
      grid-row: 2;
    }
    
    .right {
      grid-column: 3;
      grid-row: 2;
    }
    
    .keyboard-info {
      margin-top: 20px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 5px;
      text-align: center;
      color: #666;
      font-size: 14px;
    }
    
    .status {
      margin-top: 20px;
      padding: 10px;
      border-radius: 5px;
      text-align: center;
      font-weight: bold;
    }
    
    .status.connected {
      background: #d5f4e6;
      color: #27ae60;
    }
    
    .status.disconnected {
      background: #fadbd8;
      color: #e74c3c;
    }
    
    .error {
      background: #e74c3c;
      color: white;
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 20px;
      text-align: center;
    }
    
    @media (max-width: 768px) {
      .main-content {
        grid-template-columns: 1fr;
      }
      
      .video-stream, .video-placeholder {
        height: 300px;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>üéÆ Controle do Carro</h1>
    <div class="car-info">
      Carro: <span id="carId"></span>
      <a href="/carros.html" class="back-btn">Voltar</a>
    </div>
  </div>
  
  <div id="error" class="error" style="display: none;"></div>
  
  <div class="main-content">
    <div class="video-container">
      <div class="video-title">üìπ Transmiss√£o ao Vivo</div>
      <div id="videoContainer">
        <div class="video-placeholder">
          Carregando transmiss√£o...
        </div>
      </div>
    </div>
    
    <div class="controls-container">
      <div class="controls-title">üéØ Controles</div>
      
      <div class="control-grid">
        <button class="control-btn forward" id="forwardBtn" onclick="sendCommand('forward')">
          ‚¨ÜÔ∏è
        </button>
        
        <button class="control-btn left" id="leftBtn" onclick="sendCommand('left')">
          ‚¨ÖÔ∏è
        </button>
        
        <button class="control-btn backward" id="backwardBtn" onclick="sendCommand('backward')">
          ‚¨áÔ∏è
        </button>
        
        <button class="control-btn right" id="rightBtn" onclick="sendCommand('right')">
          ‚û°Ô∏è
        </button>
      </div>
      
      <div class="keyboard-info">
        <strong>Controles Dispon√≠veis:</strong><br>
        <strong>Teclado:</strong> ‚¨ÜÔ∏è‚¨áÔ∏è‚¨ÖÔ∏è‚û°Ô∏è Setas<br>
        <strong>Controle PlayStation:</strong> D-Pad ou Anal√≥gico<br>
        <strong>Mouse:</strong> Clique nos bot√µes
      </div>
      
      <div id="status" class="status disconnected">
        Desconectado
      </div>
    </div>
  </div>

  <script>
    let ws;
    let currentUser;
    let carId;
    let streamUrl;
    let isConnected = false;
    
    // teclado cont√≠nuo
    const keysPressed = {}; // ex: keysPressed['ArrowUp'] = true
    let commandLoop = null;
    const COMMAND_INTERVAL_MS = 100; // ajuste aqui (100ms envia 10x/s)


    // Vari√°veis para controle de PlayStation
    const DEAD_ZONE = 0.2;
    let lastStickValues = { x: 0, y: 0 };
    let gamepadConnected = false;

    // Obter par√¢metros da URL
    function getUrlParams() {
      const urlParams = new URLSearchParams(window.location.search);
      carId = urlParams.get('carId');
      if (!carId) {
        showError('ID do carro n√£o especificado');
        return false;
      }
      document.getElementById('carId').textContent = carId;
      return true;
    }

    // Verificar se usu√°rio est√° logado
    function checkAuth() {
      currentUser = localStorage.getItem('username');
      if (!currentUser) {
        window.location.href = '/';
        return false;
      }
      return true;
    }

    // Conectar WebSocket
    function connectWebSocket() {
      //ws = new WebSocket("ws://localhost:8080");
      const protocol = window.location.protocol === "https:" ? "wss" : "ws";
      ws = new WebSocket(`${protocol}://${window.location.host}`);


      ws.onopen = () => {
        console.log('Conectado ao servidor');
        isConnected = true;
        updateStatus('Conectado', true);
        ws.send(JSON.stringify({ 
          type: "register_user", 
          userId: currentUser 
        }));
      };

      ws.onmessage = (msg) => {
        const data = JSON.parse(msg.data);
        handleWebSocketMessage(data);
      };

      ws.onclose = () => {
        console.log('Conex√£o fechada');
        isConnected = false;
        updateStatus('Desconectado', false);
        setTimeout(connectWebSocket, 3000); // Reconectar ap√≥s 3 segundos
      };

      ws.onerror = (error) => {
        console.error('Erro WebSocket:', error);
        showError('Erro de conex√£o com o servidor');
        isConnected = false;
        updateStatus('Erro de conex√£o', false);
      };
    }

    // Processar mensagens do WebSocket
    function handleWebSocketMessage(data) {
      switch (data.type) {
        case 'registered':
          if (data.cars) {
            const car = data.cars.find(c => c.carId === carId);
            if (car) {
              streamUrl = car.streamUrl;
              setupVideoStream();
              // Automaticamente selecionar o carro
              selectCarAutomatically();
            } else {
              showError('Carro n√£o encontrado');
            }
          }
          break;
        case 'car_selected':
          console.log(`Carro ${data.carId} selecionado com sucesso!`);
          updateStatus('Conectado - Carro selecionado!', true);
          break;
        case 'error':
          showError(data.message);
          break;
      }
    }

    // Selecionar carro automaticamente
    function selectCarAutomatically() {
      if (ws && ws.readyState === WebSocket.OPEN && carId) {
        ws.send(JSON.stringify({
          type: "select_car",
          userId: currentUser,
          carId: carId
        }));
        console.log(`Selecionando carro automaticamente: ${carId}`);
      }
    }

    // Configurar stream de v√≠deo
    function setupVideoStream() {
      const videoContainer = document.getElementById('videoContainer');
      
      if (streamUrl) {
        videoContainer.innerHTML = `
          <img src="${streamUrl}" class="video-stream" alt="Stream do Carro ${carId}">
        `;
      } else {
        videoContainer.innerHTML = `
          <div class="video-placeholder">
            Stream n√£o dispon√≠vel para este carro
          </div>
        `;
      }
    }

    // Enviar comando para o carro
    function sendCommand(command) {
      if (!isConnected || !ws || ws.readyState !== WebSocket.OPEN) {
        showError('N√£o conectado ao servidor');
        return;
      }

      if (!carId) {
        showError('Nenhum carro selecionado');
        return;
      }

      ws.send(JSON.stringify({
        type: "command",
        userId: currentUser,
        command: command
      }));

      console.log(`Comando enviado: ${command}`);
    }

    // Enviar comando anal√≥gico do controle
    function sendAnalogCommand(x, y) {
      if (!isConnected || !ws || ws.readyState !== WebSocket.OPEN) {
        return;
      }

      if (!carId) {
        return; // N√£o mostrar erro para comandos anal√≥gicos cont√≠nuos
      }

      ws.send(JSON.stringify({
        type: "analog_command",
        userId: currentUser,
        x: x,
        y: y
      }));

      console.log(`Comando anal√≥gico enviado: X=${x.toFixed(2)}, Y=${y.toFixed(2)}`);
    }

    // Atualizar status da conex√£o
    function updateStatus(message, connected) {
      const statusDiv = document.getElementById('status');
      statusDiv.textContent = message;
      statusDiv.className = `status ${connected ? 'connected' : 'disconnected'}`;
    }

    // Mostrar erro
    function showError(message) {
      const errorDiv = document.getElementById('error');
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
      setTimeout(() => {
        errorDiv.style.display = 'none';
      }, 5000);
    }


    // ===== map helper =====
    function commandFromCode(code) {
      if (code === 'ArrowUp') return 'forward';
      if (code === 'ArrowDown') return 'backward';
      if (code === 'ArrowLeft') return 'left';
      if (code === 'ArrowRight') return 'right';
      return null;
    }

    function handleKeyDown(event) {
      if (!isConnected) return;
      if (!['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(event.code)) return;
      event.preventDefault();
      keysPressed[event.code] = true;
      // opcional: enviar logo ao apertar para feedback imediato
      const cmd = commandFromCode(event.code);
      if (cmd) sendCommand(cmd);
    }

    function handleKeyUp(event) {
      if (!['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(event.code)) return;
      event.preventDefault();
      keysPressed[event.code] = false;
    }

        function startCommandLoop() {
      if (commandLoop) return;
      commandLoop = setInterval(() => {
        if (!isConnected) return;
        if (keysPressed['ArrowUp']) sendCommand('forward');
        if (keysPressed['ArrowDown']) sendCommand('backward');
        if (keysPressed['ArrowLeft']) sendCommand('left');
        if (keysPressed['ArrowRight']) sendCommand('right');
      }, COMMAND_INTERVAL_MS);
    }

    function stopCommandLoop() {
      if (commandLoop) {
        clearInterval(commandLoop);
        commandLoop = null;
      }
    }

    // limpa teclas ao perder foco para evitar stuck keys
    function clearKeys() {
      Object.keys(keysPressed).forEach(k => keysPressed[k] = false);
    }
    window.addEventListener('blur', clearKeys);

    // ===== suporte a segurar bot√µes na tela (mouse/touch) =====
    function attachButtonHoldListeners() {
      const map = {
        forwardBtn: 'ArrowUp',
        backwardBtn: 'ArrowDown',
        leftBtn: 'ArrowLeft',
        rightBtn: 'ArrowRight'
      };

      Object.keys(map).forEach(id => {
        const btn = document.getElementById(id);
        if (!btn) return;
        const code = map[id];

        btn.addEventListener('pointerdown', (e) => {
          e.preventDefault();
          keysPressed[code] = true;
          const cmd = commandFromCode(code);
          if (cmd) sendCommand(cmd); // envio imediato
          btn.style.transform = 'scale(0.95)';
          btn.style.boxShadow = '0 2px 8px rgba(0,0,0,0.3)';
        });

        // pointerup e pointerleave param garantem que quando soltar fora do bot√£o a flag volte a false
        btn.addEventListener('pointerup', (e) => {
          e.preventDefault();
          keysPressed[code] = false;
          btn.style.transform = 'scale(1)';
          btn.style.boxShadow = '';
        });

        btn.addEventListener('pointercancel', () => { keysPressed[code] = false; btn.style.transform = 'scale(1)'; btn.style.boxShadow = ''; });
        btn.addEventListener('pointerleave', () => { keysPressed[code] = false; btn.style.transform = 'scale(1)'; btn.style.boxShadow = ''; });

        // optional: click fallback for older browsers
        btn.addEventListener('click', () => {
          const cmd = commandFromCode(code);
          if (cmd) sendCommand(cmd);
        });
      });
    }

    // // Controles do teclado
    // function handleKeyPress(event) {
    //   if (!isConnected) return;

    //   let buttonId = '';
      
    //   switch (event.code) {
    //     case 'ArrowUp':
    //       event.preventDefault();
    //       buttonId = 'forwardBtn';
    //       sendCommand('forward');
    //       break;
    //     case 'ArrowDown':
    //       event.preventDefault();
    //       buttonId = 'backwardBtn';
    //       sendCommand('backward');
    //       break;
    //     case 'ArrowLeft':
    //       event.preventDefault();
    //       buttonId = 'leftBtn';
    //       sendCommand('left');
    //       break;
    //     case 'ArrowRight':
    //       event.preventDefault();
    //       buttonId = 'rightBtn';
    //       sendCommand('right');
    //       break;
    //   }
    //   // Aplicar efeito visual no bot√£o correspondente
    //   if (buttonId) {
    //     const button = document.getElementById(buttonId);
    //     if (button) {
    //       // Efeito de clique
    //       button.style.transform = 'scale(0.95)';
    //       button.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.3)';
          
    //       // Restaurar ap√≥s 150ms
    //       setTimeout(() => {
    //         button.style.transform = 'scale(1)';
    //         button.style.boxShadow = '0 5px 15px rgba(0, 0, 0, 0.2)';
    //       }, 150);
    //     }
    //   }
    // }

    // Efeitos visuais nos bot√µes
    function addButtonEffects() {
      const buttons = document.querySelectorAll('.control-btn');
      
      buttons.forEach(btn => {
        btn.addEventListener('mousedown', () => {
          btn.style.transform = 'scale(0.95)';
          btn.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.3)';
        });
        
        btn.addEventListener('mouseup', () => {
          btn.style.transform = 'scale(1)';
          btn.style.boxShadow = '0 5px 15px rgba(0, 0, 0, 0.2)';
        });
        
        btn.addEventListener('mouseleave', () => {
          btn.style.transform = 'scale(1)';
          btn.style.boxShadow = '0 5px 15px rgba(0, 0, 0, 0.2)';
        });
      });
    }

    // Fun√ß√£o principal do gamepad
    function gameLoop() {
      const gamepads = navigator.getGamepads();
      if (!gamepads[0]) return;
      
      const controller = gamepads[0];
      
      // Anal√≥gico esquerdo (eixos 0 e 1)
      let yValue = Math.abs(controller.axes[1]) > DEAD_ZONE ? controller.axes[1] : 0;
      let xValue = Math.abs(controller.axes[2]) > DEAD_ZONE ? controller.axes[2] : 0;
      
      // Se houve mudan√ßa nos valores do anal√≥gico
      if (xValue !== lastStickValues.x || yValue !== lastStickValues.y) {
        sendAnalogCommand(xValue, yValue);
        lastStickValues = { x: xValue, y: yValue };
      }
      
      // Bot√µes direcionais (D-Pad)
      if (controller.buttons[12] && controller.buttons[12].pressed) { // Cima
        sendCommand('forward');
        simulateButtonPress('forwardBtn');
      }
      if (controller.buttons[13] && controller.buttons[13].pressed) { // Baixo
        sendCommand('backward');
        simulateButtonPress('backwardBtn');
      }
      if (controller.buttons[14] && controller.buttons[14].pressed) { // Esquerda
        sendCommand('left');
        simulateButtonPress('leftBtn');
      }
      if (controller.buttons[15] && controller.buttons[15].pressed) { // Direita
        sendCommand('right');
        simulateButtonPress('rightBtn');
      }
      
      requestAnimationFrame(gameLoop);
    }

    // Simular press√£o do bot√£o visualmente
    function simulateButtonPress(buttonId) {
      const button = document.getElementById(buttonId);
      if (button) {
        button.style.transform = 'scale(0.95)';
        button.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.3)';
        
        setTimeout(() => {
          button.style.transform = 'scale(1)';
          button.style.boxShadow = '0 5px 15px rgba(0, 0, 0, 0.2)';
        }, 100);
      }
    }

    // Eventos do gamepad
    window.addEventListener("gamepadconnected", (event) => {
      console.log("Controle conectado:", event.gamepad.id);
      gamepadConnected = true;
      updateStatus('Conectado - Controle detectado!', true);
      gameLoop();
    });

    window.addEventListener("gamepaddisconnected", (event) => {
      console.log("Controle desconectado:", event.gamepad.id);
      gamepadConnected = false;
      updateStatus('Conectado', true);
    });

    // Inicializar p√°gina
    function init() {
      if (!checkAuth() || !getUrlParams()) return;
      connectWebSocket();
      addButtonEffects();
      attachButtonHoldListeners();
      document.addEventListener("keydown", handleKeyDown);
      document.addEventListener("keyup", handleKeyUp);
      startCommandLoop();
      
      // garantir foco no body para capturar teclado (ajuda em alguns navegadores)
      document.body.tabIndex = -1;
      document.body.focus();
    }

    // Iniciar quando a p√°gina carregar
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
